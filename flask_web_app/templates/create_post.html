{% extends "base.html" %}

{% block cssContent %}
{% endblock cssContent %}

{% block content %}

<div class="row">
  <div class="col s12 m12 l12">
    <div class="card-panel">
      <div class="row">
        {% if post_form.post_id  %}
        <form action="{{ url_for('edit_post', post_id=post.id) }}" method="post" enctype="multipart/form-data">
        {% else %}
        <form action="{{ url_for('create_post') }}" method="post" enctype="multipart/form-data">
        {% endif %}
          {{ post_form.csrf_token }}
          <div class="col s12 m12 l12">

            <div class="input-field">
              <i class="material-icons prefix">title</i>
              {{ post_form.title.label }}
              {{ post_form.title }}
              {% if post_form.title.errors %}
              <ul style="margin-top: 0px; margin-bottom: 0px;">
                {% for error in post_form.title.errors %}
                <li><span class="red-text text-darken-1">{{ error }}</span></li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>

            {{ post_form.post_text.label }}
            <div class="input-field">
              {{ post_form.post_text(class="materialize-textarea") }}
            </div>

            <div class="row right-align">
              <div class="col s12" style="margin-bottom: -35px;">
                <a href="{{ url_for('clean_data_post') }}"
                  class="btn waves-effect waves-light red darken-1">cancelar<i
                    class="material-icons right">cancel</i></a>
                <button type="submit" class="btn waves-effect waves-light light-blue accent-4">Guardar<i
                    class="material-icons right">save</i></button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block scriptsContent %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.2.1/tinymce.min.js" type="text/javascript"></script>
<script>
  tinymce.init({
    selector: 'textarea',
    plugins: 'codesample image code table anchor charmap directionality emoticons hr imagetools insertdatetime media importcss nonbreaking pagebreak paste preview print quickbars save searchreplace toc visualblocks wordcount visualchars',
    image_title: true,
    convert_urls: false,
    automatic_uploads: true,
    images_upload_url: "{{ url_for('post_image_handler') }}",
    height: "320",
    media_live_embeds: true,
    codesample_global_prismjs: true,

    images_upload_handler: function (blobInfo, success, failure) {
      var xhr, formData;
      xhr = new XMLHttpRequest();
      xhr.withCredentials = true;
      xhr.open('POST', "{{ url_for('post_image_handler') }}");
      var token = '{{ csrf_token() }}';
      xhr.setRequestHeader("X-CSRF-TOKEN", token);
      xhr.onload = function () {
        var json;
        if (xhr.status != 200) {
          failure('HTTP Error: ' + xhr.status);
          return;
        }
        json = JSON.parse(xhr.responseText);

        if (!json || typeof json.location != 'string') {
          failure('Invalid JSON: ' + xhr.responseText);
          return;
        }
        success(json.location);
      };
      formData = new FormData();
      formData.append('file', blobInfo.blob(), blobInfo.filename());
      formData.append('csrf_token', token);
      xhr.send(formData);
    }
  });
</script>
{% endblock scriptsContent %}