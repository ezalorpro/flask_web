{% extends "base.html" %}
{% from "jinja2_macros.html" import errors  %}

{% block cssContent %}
<style>
  select {
    display: inline-block !important;
  }
</style>
{% endblock cssContent %}

{% block content %}

<div class="row">
  <div class="col s12 m12 l12">
    <div class="card-panel">
      <div class="row">
        {% if post_form.post_id  %}
        <form action="{{ url_for('edit_post', post_id=post.id) }}" method="post" enctype="multipart/form-data">
          {% else %}
          <form action="{{ url_for('create_post') }}" method="post" enctype="multipart/form-data">
            {% endif %}
            {{ post_form.csrf_token }}
            <div class="col s12 m12 l12">

              <div class="input-field">
                <i class="material-icons prefix">title</i>
                {{ post_form.title.label }}
                {{ post_form.title }}
                {% if post_form.title.errors %}
                <ul style="margin-top: 0px; margin-bottom: 0px;">
                  {% for error in post_form.title.errors %}
                  <li><span class="red-text text-darken-1">{{ error }}</span></li>
                  {% endfor %}
                </ul>
                {% endif %}
              </div>

              {{ post_form.post_text.label }}
              <div class="input-field">
                {{ post_form.post_text(class="materialize-textarea") }}
              </div>

              {{ post_form.tags_form(type="hidden") }}
              Tags:
              <div class="chips chips-autocomplete chips-initial">
                <input class="input">
              </div>

              {{ errors(post_form.tags_form) }}

              <div class="row right-align">
                <div class="col s12" style="margin-bottom: -35px;">
                  <a href="{{ url_for('clean_data_post') }}"
                    class="btn waves-effect waves-light red darken-1">cancelar<i
                      class="material-icons right">cancel</i></a>
                  <button type="submit" class="btn waves-effect waves-light light-blue accent-4">Guardar<i
                      class="material-icons right">save</i></button>
                </div>
              </div>
            </div>
          </form>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block scriptsContent %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.2.1/tinymce.min.js" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/scriptsTag.js') }}" type="text/javascript">
</script>
<script>
  function updateChipInput(newval) {
    var chips = []
    newval.forEach(element => {
      chips.push(element['tag'])
    });
    $('input[name="tags_form"]').val(chips);
  }

  $(document).ready(function () {
    tinymceFunc("{{ url_for('post_image_handler') }}", "{{ csrf_token() }}");

    $('.chips-autocomplete').chips({
      onChipAdd: function (e, chip) {
        updateChipInput(e[0].M_Chips.chipsData);
      },
      onChipDelete: function (e, chip) {
        updateChipInput(e[0].M_Chips.chipsData);
      },
      data: {{ current_tags|safe }},
      autocompleteOptions: {
        data: {{ tags|safe }},
        limit: Infinity,
        minLength: 1
      }
    });

    updateChipInput($('.chips-autocomplete')[0].M_Chips.chipsData);
  });
</script>
{% endblock scriptsContent %}