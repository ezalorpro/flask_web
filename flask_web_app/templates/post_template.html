{% extends "base.html" %}
{% from "jinja2_macros.html" import modal %}

{% block cssContent %}
{% endblock cssContent %}

{% block content %}

<div class="row">
  <div class="col s12 m12 l12">
    <h2 class="center" style="margin-top: 5px;">{{post.title}}</h2>
    {{post.post_text|safe}}
    <p> </p>
    <span class="col s6 m6 l6 right-left">
      <p><a href="{{ url_for('profile') }}">Autor: {{post.user.first_name}} {{post.user.last_name}}</a></p>
      <p>Creado el: {{post.post_date.strftime('%d/%m/%Y  %I:%M:%S %p')}}</p>
      <p>Ultima modificacion: {{post.post_modified.strftime('%d/%m/%Y  %I:%M:%S %p')}}</p>
    </span>
    <span class="col s6 m6 l6 right-align">
      {% if post.tags %}
      Tags:
      {% for tag in post.tags %}
      <div class="chip"><a href="{{ url_for('search', query=tag.name, query_type='tag') }}"
          style="color: rgba(0, 0, 0, 0.6);">{{ tag.name }}</a></div>
      {% endfor %}
      {% endif %}
    </span>
  </div>
  <div class="col s12 m12 l12">
    <ul class="collection with-header">
      <li class="collection-header">
        <h6 class="center">Comentarios</h6>
      </li>
      {% for comment in comments %}
      <li class="collection-item avatar">
        {% if comment.user.avatar %}
        <img src="{{ url_for('static', filename='images/' + comment.user.avatar) }}" alt="" class="circle">
        {% else %}
        <img src="{{ url_for('static', filename='images/default.png') }}" alt="" class="circle">
        {% endif %}
        <div>
          <input type="hidden" name="com_{{comment.id}}" id="comentario_{{comment.id}}"
            value='{{ comment.comment_text|safe }}'>
          <div id="textarea_{{comment.id}}">
            {{ comment.comment_text|safe }}
          </div>
          <div class="right-align">
            {{ comment.user.username }} <br>
            {{ comment.comment_date.strftime('%d/%m/%Y  %I:%M:%S %p') }}
            {% if current_user == comment.user %}
            <br><a href="!#" id='link_{{comment.id}}'><i class="material-icons icon-separation">edit</i></a>
            {% endif %}
          </div>
        </div>
      </li>
      {% else %}
      {% if current_user.is_authenticated %}
      No hay comentarios, se el primero en comentar
      {% else %}
      No hay comentarios. Debes logiar para poder comentar
      {% endif %}
      {% endfor %}
    </ul>

    {% if current_user.is_authenticated %}
    <form action="{{ url_for('comment_post', post_id=post.id) }}" method="post" id="principal_form">
      {{ form.csrf_token }}
      {{ form.comment_text }}
      <button id='boton_principal' type="submit" class="btn waves-effect waves-light light-blue accent-4">Comentar<i
          class="material-icons right">comment</i></button>
    </form>
    {% endif %}
  </div>
</div>
</div>

{{modal(post)}}

{% endblock content %}

{% block post_tools %}
{% if current_user == post.user %}
<div class="divider"></div>
<li><a class="subheader">Opciones</a>
</li>
<li><a href="{{ url_for('edit_post', post_id=post.id) }}">Editar<i
      class="material-icons right light-blue-text text-accent-4">edit</i></a>
</li>
<li><a href="#modal{{post.id}}" class="modal-trigger">Borrar<i
      class="material-icons right red-text text-darken-1">delete</i></a>
</li>
{% endif %}
{% endblock post_tools %}


{% block scriptsContent %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.2.1/tinymce.min.js" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/scriptsTag.js') }}" type="text/javascript">
</script>
<script>
  $(document).ready(function () {
    tinymceFuncComment('#comment_text');
    {% for comment in comments %}
    $('#link_{{comment.id}}').on('click', function (e) {
      e.preventDefault();
      $('#comentario_{{comment.id}}').wrap('<form id="form_{{comment.id}}" method="POST" action="{{ url_for("edit_comment", comment_id=comment.id) }}"></form>');
      tinymceFuncComment('#comentario_{{comment.id}}');
      $('<a class="btn waves-effect waves-light red darken-1" id="cancel_{{comment.id}}">Cancelar<i class="material-icons right">cancel</i></a>').appendTo('#form_{{comment.id}}');
      $('<button id="submit_{{comment.id}}" type="submit" class="btn waves-effect waves-light light-blue accent-4">Comentar<i class="material-icons right">comment</i></button>').appendTo('#form_{{comment.id}}');
      $('{{ form.csrf_token }}').appendTo('#form_{{comment.id}}');
      $('#textarea_{{comment.id}}').hide()
      tinymce.remove('#comment_text');
      $('#boton_principal').hide()
      $('#comment_text').hide()
      
      $("#form_{{comment.id}}").submit(function() {
        if (tinymce.activeEditor.getContent()) {
          return true
        } else {
          alert('Debe escribir algo para poder comentar');
          return false
        }
      });

      {% for links in comments %}
        $('#link_{{links.id}}').hide()
      {% endfor %}

      $("#cancel_{{comment.id}}").on('click', function (en) {
        en.preventDefault();
        $("#cancel_{{comment.id}}").unwrap();
        tinymce.remove('#comentario_{{comment.id}}');
        $('input[name ="csrf_token"]').remove();
        $('#textarea_{{comment.id}}').show()
        $('#comment_text').show()
        tinymceFuncComment('#comment_text');
        $('#boton_principal').show()
        $("#submit_{{comment.id}}").remove();
        $("#cancel_{{comment.id}}").remove();"submit_{{comment.id}}"
        $('{{ form.csrf_token }}').appendTo('#principal_form');

        {% for links in comments %}
          $('#link_{{links.id}}').show()
        {% endfor %}
      });
    
    }); 
    {% endfor %}
    
    $("#principal_form").submit(function() {
      if (tinymce.activeEditor.getContent()) {
        return true
      } else {
        alert('Debe escribir algo para poder comentar');
        return false
      }
    });
  });
</script>
{% endblock scriptsContent %}